# Submodule Commit Workflow Rule

当在 Git Submodule 内做了改动时，提交前需要在每个有改动的 submodule 中分别切出新的分支，然后分别 push 每个 submodule。

## 触发条件

当准备提交代码时，检测到以下条件：
1. 项目包含 Git Submodules（存在 `.gitmodules` 文件）
2. 有一个或多个 submodule 内存在未提交的改动

## 检查 Submodule 状态

使用以下命令检查 submodule 是否有改动：

```bash
git submodule foreach 'git status --porcelain'
```

如果输出不为空，说明对应的 submodule 有改动。

## 执行步骤

### 1. 识别有改动的 Submodules

```bash
git submodule foreach --quiet 'if [ -n "$(git status --porcelain)" ]; then echo $name; fi'
```

### 2. 对每个有改动的 Submodule 执行以下操作

#### 2.1 进入 Submodule 目录

```bash
cd <submodule-path>
```

#### 2.2 创建新分支

分支命名规则与主项目一致，参考 `auto-create-branch-on-master.md`：

```
YYMMDD-(feat|fix|chore|refactor)-xxxxx-xxxx-xxxx
```

示例：
```bash
git checkout -b 260204-feat-update-component
```

#### 2.3 提交改动

```bash
git add .
git commit -m "<commit message>"
```

#### 2.4 Push 到远程

```bash
git push -u origin <branch-name> -o merge_request.create -o merge_request.title="<auto-generated-from-commit-message>" -o merge_request.description="<auto-generated-from-commit-history>"
```

注：实际执行时，模型应该根据当前commit信息自动生成合适的MR标题和描述，确保内容准确反映代码变更。

#### 2.5 返回主项目目录

```bash
cd -
```

### 3. 更新主项目的 Submodule 引用

在所有 submodule 都提交并 push 后，回到主项目：

```bash
git add <submodule-path>
git commit -m "chore: update submodule <submodule-name> reference"
```

## 完整示例

假设项目有一个名为 `libs/common` 的 submodule，今天是 2026 年 2 月 4 日，修改了其中的组件代码：

```bash
# 1. 进入 submodule
cd libs/common

# 2. 创建新分支
git checkout -b 260204-feat-update-component

# 3. 提交改动
git add .
git commit -m "feat: update button component styles"

# 4. Push 到远程
git push -u origin 260204-feat-update-component -o merge_request.create -o merge_request.title="<auto-generated-from-commit-message>" -o merge_request.description="<auto-generated-from-commit-history>"

注：实际执行时，模型应该根据当前commit信息自动生成合适的MR标题和描述，确保内容准确反映代码变更。

# 5. 返回主项目
cd -

# 6. 更新主项目的 submodule 引用
git add libs/common
git commit -m "chore: update submodule libs/common reference"
```

## 多个 Submodule 的情况

如果有多个 submodule 都有改动，需要依次对每个 submodule 执行上述步骤：

```bash
# 列出所有有改动的 submodules
git submodule foreach --quiet 'if [ -n "$(git status --porcelain)" ]; then echo $name; fi'

# 对每个 submodule 分别执行：创建分支 → 提交 → push
# 最后统一更新主项目的引用
```

## 注意事项

- 每个 submodule 的分支名应该与其改动内容相关，而非简单复制主项目的分支名
- 确保 submodule 的远程仓库有推送权限
- 使用 -o merge_request.create 选项可以在 push 后自动创建 Merge Request
- 使用 -o merge_request.title 和 -o merge_request.description 选项可设置 MR 的标题和描述
- 主项目的 submodule 引用更新应该在所有 submodule 都成功 push 后再进行
- 如果某个 submodule push 失败，需要先解决问题后再继续

## MR 自动化说明

- MR 标题：模型应该根据提交信息的内容自动生成简洁的标题，如 `feat(backend/auth): 用户登录模块实现 oauth2 认证`
- MR 描述：模型应该基于提交历史生成所修改内容的无序列表，便于代码审查人员了解具体改动内容
- 当有多个提交时，模型应该智能合并相关信息，生成清晰的MR概要
- 为避免命令注入风险，不直接使用复杂命令行参数 直接生成 push 命令，而是先执行 `git log --oneline -s` 获取本分支的变更清单，再由模型动态生成合适的标题和描述

## 相关规则

- [auto-create-branch-on-master.md](./auto-create-branch-on-master.md) - 分支命名规范
- [git-submodule-check.md](./git-submodule-check.md) - Submodule 初始化检查
